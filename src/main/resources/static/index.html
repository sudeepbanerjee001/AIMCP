<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AIMCP — Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body class="bg-slate-50">
<div id="root" class="min-h-screen flex items-center justify-center p-4"></div>

<script type="text/javascript">
    const e = React.createElement;
    const { useState, useEffect, useRef } = React;

    const WS_URL = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/mcp';

    function App(){
      const [connected, setConnected] = useState(false);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const wsRef = useRef(null);
      const idCounter = useRef(1000);

      useEffect(()=>{
        connect();
        return ()=>{
          if(wsRef.current) wsRef.current.close();
        }
      },[]);

      function addMessage(role, text){
        setMessages(m=>[...m, {id: Date.now()+Math.random(), role, text}]);
      }

      function connect(){
        const ws = new WebSocket(WS_URL);
        wsRef.current = ws;
        ws.onopen = ()=>{
          setConnected(true);
          addMessage('system','Connected to MCP server');
          // send initialize
          const id = nextId();
          const init = { jsonrpc: '2.0', id: String(id), method: 'initialize', params: { clientInfo: { name: 'web-client', version: '1.0' } } };
          ws.send(JSON.stringify(init));
        }
        ws.onmessage = (evt)=>{
          try{
            const data = JSON.parse(evt.data);
            // handle json-rpc responses
            if(data.method){
              // server push notifications
              if(data.method === 'resource_update'){
                addMessage('system', "Resource update: "+JSON.stringify(data.params));
              }
              return;
            }

            if(data.result){
              // if result contains text from LLM, show it
              if(data.result && data.result.output){
                addMessage('assistant', data.result.output);
              } else if(data.result && data.result.resources){
                addMessage('system', 'Resources: '+ JSON.stringify(data.result.resources));
              } else {
                addMessage('system', 'Result: '+JSON.stringify(data.result));
              }
            } else if(data.error){
              addMessage('system', 'Error: '+data.error.message+' ('+data.error.code+')');
            }
          }catch(e){
            console.error('invalid message', evt.data, e);
          }
        }
        ws.onclose = ()=>{ setConnected(false); addMessage('system','Disconnected'); }
        ws.onerror = (e)=>{ console.error('ws error', e); }
      }

      function nextId(){ return ++idCounter.current; }

      function sendMessage(){
        if(!input.trim()) return;
        addMessage('user', input);
        // create a call_tool JSON-RPC request
        const id = String(nextId());
        const payload = {
          jsonrpc: '2.0',
          id,
          method: 'call_tool',
          params: {
            tool: 'llm',
            model: 'mistral:7b-instruct-v0.3-q8_0',
            input: input
          }
        };
        try{
          wsRef.current.send(JSON.stringify(payload));
        }catch(e){ addMessage('system','Cannot send — not connected'); }
        setInput('');
      }

      return e('div',{className:'w-full max-w-3xl bg-white rounded-2xl shadow p-4 flex flex-col'},
        e('div',{className:'flex items-center gap-3 mb-4'},
          e('div',{className:'flex-1'}, e('h1',{className:'text-xl font-semibold'}, 'Comms ChatGPT') ),
          e('div', {className:'text-sm'}, connected? e('span',{className:'text-green-600'} ,'● connected') : e('span',{className:'text-red-500'}, '● disconnected'))
        ),

        e('div',{className:'flex-1 overflow-auto mb-4', style:{minHeight:'400px'}},
          e('div',{className:'flex flex-col gap-3'}, messages.map(msg=> e(MessageBubble, {key:msg.id, msg})) )
        ),

        e('div',{className:'flex gap-2'},
          e('textarea',{value:input, onChange:(ev)=>setInput(ev.target.value), placeholder:'Type your message...', className:'flex-1 p-3 rounded-lg border', rows:2}),
          e('button',{onClick:sendMessage, className:'px-4 py-2 bg-blue-600 text-white rounded-lg'}, 'Send')
        )
      );
    }

    function MessageBubble({msg}){
      if(msg.role === 'user'){
        return e('div',{className:'flex justify-end'}, e('div',{className:'bg-blue-600 text-white px-4 py-2 rounded-lg max-w-[75%]'}, msg.text));
      } else if(msg.role === 'assistant'){
        return e('div',{className:'flex justify-start'}, e('div',{className:'bg-slate-100 px-4 py-2 rounded-lg max-w-[75%]'}, msg.text));
      } else {
        return e('div',{className:'text-xs text-slate-500'}, msg.text);
      }
    }

    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
</script>
</body>
</html>
